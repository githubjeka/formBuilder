/*
formBuilder - git@github.com:kevinchappell/formBuilder.git
Version: 1.3.0
Author: Kevin Chappell <kevin.b.chappell@gmail.com>
*/
"use strict";!function(e){e.fn.toXML=function(t){var a={prepend:"",attributes:["class"]},l=e.extend(a,t),i="";return this.each(function(){var t=0,a=1;e(this).children().length>=1&&(i+="<form-template>\n	<fields>",e(this).children().each(function(){var o=e(this);if(!o.hasClass("moving")&&!o.hasClass("disabled"))for(var n=0;n<l.attributes.length;n++){var r=e("input.required",o).is(":checked")?'required="true" ':'required="false" ',s=e('input[name="multiple"]',o).is(":checked"),c=s?'style="multiple" ':"",d=o.attr(l.attributes[n]),p='type="'+d+'" ',u='name="'+e("input.fld-name",o).val()+'" ',f='label="'+e("input.fld-label",o).val()+'" ',m=e.map(e("input.roles-field:checked",o),function(e){return e.value}).join(","),v=""!==m?'role="'+m+'" ':"",h='description="'+e("input.fld-description",o).val()+'" ',b=e("input.fld-max-length",o).val(),g='max-length="'+(void 0!==b?b:"")+'" ',x="select"!==d&&"checkbox-group"!==d?"/":"";i+="\n		<field "+u+f+c+v+h+(""!==b&&void 0!==b?g:"")+r+p+x+">",("select"===d||"checkbox-group"===d)&&(a=1,e("input[type=text][class=option]",o).each(function(){if("title"!==e(this).attr("name")){var t=e(this).prev().is(":checked")?' selected="true"':"";i+="\n			<option"+t+">"+e(this).val()+"</option>"}a++}),i+="\n		</field>")}t++}),i+="\n	</fields>\n</form-template>")}),i}}(jQuery),function(e){var t=function(t,a){var l,i,o={disableFields:{},defaultFields:[],roles:[{value:1,label:"Administrator"}],showWarning:!1,serializePrefix:"frmb",labels:{add:"Add Item",allowSelect:"Allow Select",autocomplete:"Autocomplete",cannotBeEmpty:"This field cannot be empty",checkboxGroup:"Checkbox Group",checkbox:"Checkbox",checkboxes:"Checkboxes","class":"Class",clearAllMessage:"Are you sure you want to remove all items?",clearAll:"Clear All",close:"Close",copy:"Copy To Clipboard",date:"Date Field",description:"Help Text",descriptionField:"Description",devMode:"Developer Mode",disableFields:"These fields cannot be moved.",editNames:"Edit Names",editXML:"Edit XML",fieldRemoveWarning:"Are you sure you want to remove this field?",getStarted:"Drag a field from the right to this area",hide:"Edit",label:"Label",labelEmpty:"Field Label cannot be empty",limitRole:"Limit access to one or more of the following roles:",mandatory:"Mandatory",maxLength:"Max Length",minOptionMessage:"This field requires a minimum of 2 options",name:"Name",no:"No",off:"Off",on:"On",optional:"optional",options:"Options",optionLabelPlaceholder:"Label",optionValuePlaceholder:"Value",optionEmpty:"Option value required",paragraph:"Paragraph",preview:"Preview",radioGroup:"Radio Group",radio:"Radio",removeMessage:"Remove Element",remove:"&#215;",required:"Required",roles:"Limit Access",save:"Save Template",selectOptions:"Select Items",select:"Select",selectionsMessage:"Allow Multiple Selections",text:"Text Field",textarea:"Text Area",warning:"Warning!",viewXML:"View XML",yes:"Yes"}},n={};n.uniqueArray=function(e){return e.filter(function(e,t,a){return a.indexOf(e)===t})},n.startMoving=function(t,a){t=t,a.item.addClass("moving"),l=e("li",this).index(a.item)},n.stopMoving=function(t,a){t=t,a.item.removeClass("moving"),i&&(e(a.sender).sortable("cancel"),e(this).sortable("cancel"))},n.safename=function(e){return e.replace(/\s/g,"-").replace(/[^a-zA-Z0-9\-]/g,"").toLowerCase()},n.forceNumber=function(e){return e.replace(/[^0-9]/g,"")},n.initTooltip=function(e){var t=e.find(".tooltip");e.mouseenter(function(){t.outerWidth()>200&&t.addClass("max-width"),t.css("left",e.width()+14),t.stop(!0,!0).fadeIn("fast")}).mouseleave(function(){e.find(".tooltip").stop(!0,!0).fadeOut("fast")}),t.hide()},n.save=function(){_.children("li").not(".disabled").each(function(){n.updatePreview(e(this))}),c.val(_.toXML())},n.updatePreview=function(t){var a;e(".prev-holder",t).html(a)},n.nameAttr=function(e){var t=(new Date).getTime();return e+"-"+t},n.htmlEncode=function(t){return e("<div/>").text(t).html()},n.htmlDecode=function(t){return e("<div/>").html(t).text()},n.validateForm=function(){var t=[];e('input[name="label"], input[type="text"].option',_).each(function(){if(""===e(this).val()){var a=e(this).parents("li.form-field"),l=e(this);t.push({field:a,error:s.labels.labelEmpty,attribute:l})}}),t.length&&(alert("Error: "+t[0].error),e("html, body").animate({scrollTop:t[0].field.offset().top},1e3,function(){var a=e(".toggle-form",t[0].field).attr("id");e(".toggle-form",t[0].field).addClass("open").parent().next(".prev-holder").slideUp(250),e("#"+a+"-fld").slideDown(250,function(){t[0].attribute.addClass("error")})}))},n.disabledTT=function(t){var a=t.attr("data-tooltip");if(a){t.removeAttr("title").data("tip_text",a);var l=e("<p/>",{"class":"frmb-tt"}).html(a);t.append(l),l.css({top:-l.outerHeight(),left:-15}),t.mouseleave(function(){e(this).attr("data-tooltip",t.data("tip_text")),e(".frmb-tt").remove()})}},String.prototype.toCamelCase=function(){return this.replace(/(\-\w)/g,function(e){return e[1].toUpperCase()})},n.markup=function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],a=arguments.length<=2||void 0===arguments[2]?"":arguments[2];t=q(t),a=Array.isArray(a)?a.join(""):a;var l=["input"],i=-1===l.indexOf(e)?"<"+e+" "+t+">"+a+"</"+e+">":"<"+e+" "+t+"/>";return i};var r=function(t){var a,l=Object.assign({},{label:t.label},t.attrs,t.meta),i=l.roles.map(function(e){return e.type="checkbox",e}),o=["required","label","description","class","roles","name"];if(l.name=l.name||n.nameAttr(l.type),-1!==e.inArray(l.type,["checkbox","select","checkbox-group","date","autocomplete"])||l.maxLength||(l.maxLength="",o.push("maxLength")),l.roles={options:i,value:1,type:"checkbox"},t.options){var r=t.options.map(function(e,t){var a={options:[],type:"none"};for(var l in e)if(e.hasOwnProperty(l)){var i={value:e[l],label:l,name:"option-"+l};"selected"===l&&(i.type="checkbox"),a.options.push(i)}return a});l.options={options:r,label:s.labels.options,type:"none"}}return delete l.type,a=n.uniqueArray(o.concat(Object.keys(l))).map(function(e){var t={name:e};return"object"==typeof l[e]?Object.assign(t,l[e]):t.value=l[e],t})},s=e.extend(o,a),c=e(t),d="frmb-"+e("ul[id^=frmb-]").length++,p=1,u=d+"-control-box",f=[{id:"text","class":"icon-text"},{id:"autocomplete","class":"icon-autocomplete"},{id:"select","class":"icon-select"},{id:"textarea","class":"icon-text-area"},{id:"date","class":"icon-calendar"},{id:"radio-group","class":"icon-radio-group"},{id:"checkbox","class":"icon-checkbox"},{id:"checkbox-group","class":"icon-checkbox-group"}],m=e("<ul/>",{id:u,"class":"frmb-control"}),v=f.map(function(t){var a=t.id.toCamelCase(),l=n.nameAttr(t.id),i={label:s.labels[a],meta:{description:"",roles:s.roles},attrs:{type:t.id,name:l,"class":t["class"],required:!1,id:l}};return-1!==e.inArray(t.id,["select","checkbox-group","radio-group"])&&(i.options=[{selected:!1,value:"option-1-value",label:"Option 1 Label"},{selected:!1,value:"option-2-value",label:"Option 2 Label"}]),i.properties=r(i),e("<li/>",i.attrs).data("fieldData",i).html(i.label).removeAttr("type")});m.append(v);var h=e("<a/>",{id:d+"-export-xml",text:s.labels.viewXML,"class":"view-xml"}),b=e("<a/>",{id:d+"-allow-select",text:s.labels.allowSelect,"class":"allow-select"}).prop("checked","checked"),g=e("<a/>",{id:d+"-edit-xml",text:s.labels.editXML,"class":"edit-xml"}),x=e("<a/>",{id:d+"-edit-names",text:s.labels.editNames,"class":"edit-names"}),y=e("<button/>",{text:s.labels.clearAll,"class":"clear-all btn btn-default"}),k=e("<button/>",{id:d+"-save",text:s.labels.save,"class":"save btn btn-primary"}),C=e("<div/>",{id:d+"-actions","class":"form-actions btn-group"}),w=e("<div/>",{id:d+"-action-links-inner","class":"action-links-inner"}).append(g," | ",x," | ",b," | ",y," |&nbsp;"),T=e("<span/>",{"class":"dev-mode-link"}).html(s.labels.devMode+" "+s.labels.off),M=e("<div/>",{id:d+"-action-links","class":"action-links"}).append(w,T);C.append(y,k);var _=e("<ul/>").attr("id",d).addClass("frmb").sortable({cursor:"move",opacity:.9,beforeStop:function(t,a){t=t;var l=e("> li",_).length-1,o=a.placeholder.index();i=1>=o||o===l},over:function(t){e(t.target).parent().addClass("active")},start:n.startMoving,stop:n.stopMoving,cancel:"input, .disabled, .sortable-options, .add, .btn, .no-drag, .prev-holder select",placeholder:"frmb-placeholder"});m.sortable({helper:"clone",opacity:.9,connectWith:_,cursor:"move",placeholder:"ui-state-highlight",start:n.startMoving,stop:n.stopMoving,revert:150,remove:function(t,a){0===l?m.prepend(a.item):e("li:eq("+(l-1)+")",m).after(a.item)},update:function(t,a){c.stopIndex=0===e("li",_).index(a.item)?"0":e("li",_).index(a.item),e("li",_).index(a.item)<0?e(this).sortable("cancel"):D(a.item,!0)},receive:function(t,a){(a.sender.hasClass("frmb")||a.sender.hasClass("frmb-control"))&&e(a.sender).sortable("cancel")}}),c.before(_).parent().addClass("frmb-wrap").append(M,h);var A=e("<div/>",{id:d+"-cb-wrap","class":"cb-wrap"}).append(m,C),O=e(".frmb-wrap").before(A).append(M),E=function(){if(0===e(this).parents("li.disabled").length){if("label"===e(this).name&&""===e(this).val())return alert("Error: "+s.labels.labelEmpty);n.save()}};e("input, select",_).on("change",E),e("input, select",_).on("blur",E),c.getTemplate=function(){var t=""!==c.val()?e.parseXML(c.val()):!1,a=e(t).find("field");if(a.length>0)a.each(function(){D(e(this))});else if(!t){if(s.defaultFields.length)for(var l=s.defaultFields.length-1;l>=0;l--)I(s.defaultFields[l]);else O.addClass("empty").attr("data-content",s.labels.getStarted);L()}};var L=function(){var t='<li class="disabled __POSITION__">__CONTENT__</li>';s.disableFields.before&&!e(".disabled.before",_).length&&_.prepend(t.replace("__POSITION__","before").replace("__CONTENT__",s.disableFields.before)),s.disableFields.after&&!e(".disabled.after",_).length&&_.append(t.replace("__POSITION__","after").replace("__CONTENT__",s.disableFields.after))},D=function(e){var t=e.data("fieldData");I(t),O.removeClass("empty"),L()},I=function(t){var a="",l=n.markup("a",{"class":"del-button btn",title:s.labels.removeMessage,id:"del_"+p},s.labels.remove),i=n.markup("a",{id:"frm-"+p,"class":"toggle-form btn icon-pencil",title:s.labels.hide}),o=n.markup("span",{"class":"required-asterisk"},"*"),r=t.description?n.markup("span",{"class":"tooltip-element",tooltip:t.description},"?"):"",d=n.markup("div",{"class":"field-label"},t.label,o,r),u=n.markup("div",{"class":"field-actions"},[i,l]),f=n.markup("div",{id:"frm-"+p+"-fld","class":"field-properties"},F(t.properties));a=n.markup("li",{id:"frm-"+p+"-item","class":t.attrs.type+" form-field"},[u,d,S(t),f]),c.stopIndex?e("li",_).eq(c.stopIndex).after(a):_.append(a),e(document.getElementById("frm-"+p+"-item")).hide().slideDown(250),p++,n.save()},q=function(e){var t=[];for(var a in e)e.hasOwnProperty(a)&&t.push(a+'="'+e[a]+'"');return t.join(" ")},F=function(e){return e.map(function(e){var t=n.markup("div",{"class":"field-property "+e.name+"-wrap"},N(e));return t})},N=function G(t){var a=arguments.length<=1||void 0===arguments[1]?0:arguments[1],l=t.name||"",i=(l+"-"+p).replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),o=t.label||s.labels[l.toCamelCase()]||!1,r=t.fields||[],c=t.type||"text",d=t.value||"",u=[];if(t.options&&(a++,r=t.options.map(function(e){return G(e,a)}),r=n.markup("div",{"class":"property-options-"+a},r)),"none"!==c){var f={type:c,name:i,value:d,id:i,"class":"edit-"+l};2===a?f.placeholder=o.charAt(0).toUpperCase()+o.slice(1):1===a&&setTimeout(function(){e(".property-options-1",document.getElementById("frm-"+p+"-item")).sortable()},1e3),u.push(n.markup("input",f))}return o&&u.push(n.markup("label",{"for":i},o)),u.push(u,r),u.join("")},S=function(e){delete e.attrs["class"];var t={},a=e.attrs.type.toCamelCase();return t.text=function(e){var t=q(e.attrs),a="<input "+t+">",l=(e.attrs.value||"",'<label for="'+e.attrs.id+'">'+e.label+"</label>"),i={};return i.text=l+a,i.password=i.text,i.autocomplete=i.text,i.date=i.text,i[e.attrs.type]},t.password=Object.assign(t.text),t.email=t.text,t.date=t.text,t.autocomplete=t.text,t.textarea=function(e){var t=q(e.attrs),a=e.attrs.value||"",l="<textarea "+t+">"+a+"</textarea>",i='<label for="'+e.attrs.id+'">'+e.label+"</label>";return i+l},t.checkbox=function(e){var t=q(e.attrs);return'<label for="'+e.attrs.id+'"><input '+t+"> "+e.label+"</label>"},t.radio=t.checkbox,t.select=function(e){var t=void 0,a=e.attrs,l=function(e){var t=e.selected?"selected":"";return'<option value="'+e.value+'" '+t+">"+e.label+"</option>"},i=void 0;for(e.options.reverse(),i=e.options.length-1;i>=0;i--)t+=l(e.options[i]);return"<"+a.type+">"+t+"</"+a.type+">"},t.checkboxGroup=function(e){var a=[],l=Object.assign({},e);return l.attrs.type=l.attrs.type.replace("-group",""),l.attrs.name=l.attrs.name+"[]",delete l.options,e.options.forEach(function(e){l.label=e.label,l.attrs.value=e.value,a.push(t[l.attrs.type](l))}),a.join("")},t.radioGroup=t.checkboxGroup,'<div class="prev-holder">'+t[a](e)+"</div>"};_.on("click",".remove",function(t){t.preventDefault();var a=e(this).parents(".sortable-options:eq(0)").children("li").length;2>=a?alert("Error: "+s.labels.minOptionMessage):e(this).parent("li").slideUp("250",function(){e(this).remove()})}),_.on("click",".toggle-form",function(t){t.preventDefault();var a=document.getElementById(e(this).attr("id")+"-item");e(".prev-holder",a).toggleClass("open").slideToggle(250),e(".field-properties",a).slideToggle(250,function(){})}),_.on("keyup",".edit-label",function(t){e(".field-label",e(this).closest("li")).html(e(this).val())}),_.on("keyup","input.error",function(){e(this).removeClass("error")}),_.on("keyup",".edit-description",function(t){t.preventDefault();var a=e(".tooltip-element",e(this).closest("li"));if(""!==e(this).val())if(a.length)a.attr("tooltip",e(this).val()).css("display","inline-block");else{var l='<span class="tooltip-element" tooltip="'+e(this).val()+'">?</span>';e(".field-label",e(this).closest("li")).append(l)}else a.length&&a.css("display","none")}),_.on("keyup",".edit-name",function(){e(this).val(n.safename(e(this).val())),""===e(this).val()?e(this).addClass("field_error").attr("placeholder",s.labels.cannotBeEmpty):e(this).removeClass("field_error")}),_.on("keyup","input.fld-max-length",function(){e(this).val(n.forceNumber(e(this).val()))}),_.on("click",".del-button",function(t){t.preventDefault();var a=e(this).parents(".form-field:eq(0)");s.showWarning,j(a)});var j=function(t){var a=e("<h3/>").html("<span></span>"+s.labels.warning);e("<div />").append(a,s.labels.fieldRemoveWarning).dialog({modal:!0,resizable:!1,width:300,dialogClass:"ite-warning",buttons:[{text:s.labels.yes,click:function(){n.removeField(t),e(this).dialog("close")}},{text:s.labels.no,click:function(){e(this).dialog("close")}}]})};n.removeField=function(t){t.slideUp(250,function(){e(this).remove(),n.save()})},_.on("click",".edit-required",function(){var t=e(this).parents("li.form-field").find(".required-asterisk");t.toggle()}),_.on("click",".edit-roles",function(){var t=e(this).siblings(".property-options-1"),a=e(this);t.slideToggle(250,function(){a.is(":checked")||e('input[type="checkbox"]',t).removeAttr("checked")})}),_.on("mouseenter","li.disabled .form-element",function(){n.disabledTT(e(this))}),_.on("click",".close-field",function(t){t.preventDefault(),e(this).parents("li.form-field").find(".toggle-form").trigger("click")}),_.on("hover",".del-button",function(t){console.log("hovering!!");var a=e(this).parents(".form-field:eq(0)");a.toggleClass("delete")}),e(document.getElementById(d+"-export-xml")).click(function(t){t.preventDefault();var a=c.val(),l=e("<pre />").text(a);l.dialog({resizable:!1,modal:!0,width:720,dialogClass:"frmb-xml",overlay:{color:"#333333"}})}),y.click(function(e){e.preventDefault(),window.confirm(s.labels.clearAllMessage)&&(_.empty(),c.val(""),n.save(),c.getTemplate())}),y.hover(function(){e(this).toggleClass("btn-danger").toggleClass("btn-default")}),e(document.getElementById(d+"-save")).click(function(e){e.preventDefault(),O.hasClass("edit-xml")||n.save(),n.validateForm(e)});var B=!1,P=[],X="68,69,86";e(".save.btn").mouseover(function(){B=!0}).mouseout(function(){B=!1}),e(document.documentElement).keydown(function(t){P.push(t.keyCode),P.toString().indexOf(X)>=0&&(e(".action-links").toggle(),e(".view-xml").toggle(),P=[])}),e(".dev-mode-link").click(function(t){t.preventDefault();var a=e(this);O.toggleClass("dev-mode"),a.parent().css("opacity",1),O.hasClass("dev-mode")?(a.siblings(".action-links-inner").css("width","100%"),a.html(s.labels.devMode+" "+s.labels.on).css("color","#8CC63F")):(a.siblings(".action-links-inner").css("width",0),a.html(s.labels.devMode+" "+s.labels.off).css("color","#666666"),B=!1,e(".action-links").toggle(),e(".view-xml").toggle())}),e(document.getElementById(d+"-edit-names")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e(".name_wrap",_).slideToggle(250,function(){O.toggleClass("edit-names")})}),e(document.getElementById(d+"-allow-select")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e(".allow-multi, .select-option",_).slideToggle(250,function(){O.toggleClass("allow-select")})}),e(document.getElementById(d+"-edit-xml")).click(function(t){t.preventDefault(),e(this).toggleClass("active"),e("textarea.idea-template").show(),e(".template-textarea-wrap").slideToggle(250),O.toggleClass("edit-xml")}),O.css("min-height",m.height()-48),c.wrap('<div class="template-textarea-wrap"/>').getTemplate()};e.fn.formBuilder=function(a){var l=this;return l.each(function(){var l=e(this);if(!l.data("formBuilder")){var i=new t(this,a);l.data("formBuilder",i)}})}}(jQuery);